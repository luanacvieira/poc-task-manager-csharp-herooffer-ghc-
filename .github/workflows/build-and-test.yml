name: Build and Test with Coverage

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.0.x'
  MIN_TEST_SUCCESS_RATE: 80

jobs:
  test-and-build:
    name: Test & Build .NET Application
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore
      
    - name: ğŸ”¨ Build solution
      run: dotnet build --no-restore --configuration Release
      
    - name: ğŸ§ª Run Tests with Coverage
      id: test
      run: |
        echo "Running tests with coverage..."
        dotnet test --no-build --configuration Release \
          --verbosity normal \
          --collect:"XPlat Code Coverage" \
          --results-directory ./TestResults \
          --logger "trx;LogFileName=test-results.trx" \
          --logger "console;verbosity=detailed"
      continue-on-error: true
      
    - name: ğŸ“Š Parse Test Results
      id: parse-results
      run: |
        # Install xmlstarlet for XML parsing
        sudo apt-get update && sudo apt-get install -y xmlstarlet
        
        # Find the test results file
        TRX_FILE=$(find ./TestResults -name "*.trx" | head -n 1)
        
        if [ -z "$TRX_FILE" ]; then
          echo "âŒ No test results file found!"
          exit 1
        fi
        
        echo "ğŸ“„ Test results file: $TRX_FILE"
        
        # Parse test results
        TOTAL=$(xmlstarlet sel -t -v "//ResultSummary/Counters/@total" "$TRX_FILE")
        PASSED=$(xmlstarlet sel -t -v "//ResultSummary/Counters/@passed" "$TRX_FILE")
        FAILED=$(xmlstarlet sel -t -v "//ResultSummary/Counters/@failed" "$TRX_FILE")
        
        echo "total_tests=$TOTAL" >> $GITHUB_OUTPUT
        echo "passed_tests=$PASSED" >> $GITHUB_OUTPUT
        echo "failed_tests=$FAILED" >> $GITHUB_OUTPUT
        
        # Calculate success rate
        if [ "$TOTAL" -gt 0 ]; then
          SUCCESS_RATE=$(awk "BEGIN {printf \"%.2f\", ($PASSED / $TOTAL) * 100}")
        else
          SUCCESS_RATE=0
        fi
        
        echo "success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT
        
        echo "ğŸ“Š Test Results:"
        echo "  Total: $TOTAL"
        echo "  Passed: $PASSED"
        echo "  Failed: $FAILED"
        echo "  Success Rate: $SUCCESS_RATE%"
        echo "  Minimum Required: ${{ env.MIN_TEST_SUCCESS_RATE }}%"
        
    - name: âœ… Validate Test Success Rate
      run: |
        TOTAL=${{ steps.parse-results.outputs.total_tests }}
        PASSED=${{ steps.parse-results.outputs.passed_tests }}
        FAILED=${{ steps.parse-results.outputs.failed_tests }}
        SUCCESS_RATE=${{ steps.parse-results.outputs.success_rate }}
        MIN_RATE=${{ env.MIN_TEST_SUCCESS_RATE }}
        
        echo "=================================="
        echo "ğŸ“Š TEST RESULTS SUMMARY"
        echo "=================================="
        echo "Total Tests: $TOTAL"
        echo "Passed: âœ… $PASSED"
        echo "Failed: âŒ $FAILED"
        echo "Success Rate: $SUCCESS_RATE%"
        echo "Minimum Required: $MIN_RATE%"
        echo "=================================="
        
        # Compare success rate (using bc for floating point comparison)
        if (( $(echo "$SUCCESS_RATE >= $MIN_RATE" | bc -l) )); then
          echo "âœ… SUCCESS: Test success rate ($SUCCESS_RATE%) meets minimum requirement ($MIN_RATE%)"
          echo "ğŸ‰ Build will proceed!"
          exit 0
        else
          echo "âŒ FAILURE: Test success rate ($SUCCESS_RATE%) is below minimum requirement ($MIN_RATE%)"
          echo "âš ï¸  Build aborted!"
          exit 1
        fi
        
    - name: ğŸ“ˆ Generate Coverage Report
      if: success()
      run: |
        # Install ReportGenerator
        dotnet tool install --global dotnet-reportgenerator-globaltool
        
        # Generate HTML coverage report
        reportgenerator \
          -reports:./TestResults/**/coverage.cobertura.xml \
          -targetdir:./TestResults/CoverageReport \
          -reporttypes:"Html;Cobertura;MarkdownSummary" \
          -verbosity:Warning
          
        echo "ğŸ“Š Coverage report generated at ./TestResults/CoverageReport"
        
    - name: ğŸ“‹ Display Coverage Summary
      if: success()
      run: |
        if [ -f "./TestResults/CoverageReport/Summary.md" ]; then
          echo "ğŸ“Š Code Coverage Summary:"
          cat ./TestResults/CoverageReport/Summary.md
        fi
        
    - name: ğŸ“¤ Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          ./TestResults/*.trx
          ./TestResults/CoverageReport/
        retention-days: 30
        
    - name: ğŸ“¤ Upload Coverage Report
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: ./TestResults/CoverageReport/
        retention-days: 30
        
    - name: ğŸ’¬ Comment PR with Results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        script: |
          const totalTests = '${{ steps.parse-results.outputs.total_tests }}';
          const passedTests = '${{ steps.parse-results.outputs.passed_tests }}';
          const failedTests = '${{ steps.parse-results.outputs.failed_tests }}';
          const successRate = '${{ steps.parse-results.outputs.success_rate }}';
          const minRate = '${{ env.MIN_TEST_SUCCESS_RATE }}';
          
          const passed = parseFloat(successRate) >= parseFloat(minRate);
          const emoji = passed ? 'âœ…' : 'âŒ';
          const status = passed ? 'PASSED' : 'FAILED';
          
          const body = `## ${emoji} Test Results - ${status}
          
          ### ğŸ“Š Summary
          
          | Metric | Value |
          |--------|-------|
          | **Total Tests** | ${totalTests} |
          | **Passed** | âœ… ${passedTests} |
          | **Failed** | âŒ ${failedTests} |
          | **Success Rate** | **${successRate}%** |
          | **Minimum Required** | ${minRate}% |
          | **Status** | ${emoji} ${status} |
          
          ${passed 
            ? 'âœ… **Build Approved**: Test success rate meets the minimum requirement!' 
            : 'âŒ **Build Rejected**: Test success rate is below the minimum requirement!'}
          
          ---
          
          ğŸ“„ **Workflow Run**: [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });
          
    - name: ğŸ‰ Build Success
      if: success()
      run: |
        echo "=================================="
        echo "âœ… BUILD SUCCESSFUL!"
        echo "=================================="
        echo "All tests passed with required success rate"
        echo "Coverage report generated successfully"
        echo "Build artifacts are ready"
        echo "=================================="
        
    - name: âŒ Build Failed
      if: failure()
      run: |
        echo "=================================="
        echo "âŒ BUILD FAILED!"
        echo "=================================="
        echo "Tests did not meet minimum success rate"
        echo "Please review test results and fix failing tests"
        echo "=================================="
        exit 1

